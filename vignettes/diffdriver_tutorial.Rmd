---
title: "A tutorial to run diffdriver"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE, 
  message = FALSE
)
```

# Environment requirement

Need 16G memory to run diffdriver. The place that need the most memory is for parameter estimation for background mutation rate.

# Prepare input

  * Gene file
```{r}
genef = system.file("extdata", "example_gene.txt", package = "diffdriver")
gene <- read.table(genef, header = F)
head(gene)
```

  * Mutation file
```{r}
mutf = system.file("extdata/", "example_mutations.txt", package = "diffdriver")
mut <- read.table(mutf, header = T)
head(mut)
```

  * Phenotype file

The first column is sample ID with column name "SampleID", the second column is phenotype with the phenotype name as column name (note no space or in tab in column names are allowed). 
```{r}
phenof = system.file("extdata/", "example_phenotypes.txt", package = "diffdriver")
pheno <- read.table(phenof, header = T)
head(pheno)
```

  * Directory that contains annotation files

```{r}
annodir = "~/temp/annodir96"
list.files(annodir)
```


# Run diffdriver

```{r}
# library(diffdriver)
output_dir <- "~/temp/output"
```

With signature adjustment, takes around 10min for two genes. Each additional gene will take 3-4 minutes. Please use the provide the annotation folder with 96 annotation files. `j` is the column that will be used as the phenotype, e.g j=2 means the second column in the phenotype file will be used as phenotype. 
```{r}
res <- diffdriver(gene = gene, mut= mut, pheno = pheno, anno_dir = "~/temp/annodir96", k=6, totalnttype = 96, BMRmode = "signature", output_dir = output_dir, output_prefix = "testdiffdriver_sig")
res
```

Without signature adjustment, takes around 5min for two genes. Each additional gene will take 2 minutes.Please use the provide the annotation folder with 9 annotation files. 
```{r}
res <- diffdriver(gene = gene, mut= mut, pheno = pheno,  anno_dir = "~/temp/annodir9", totalnttype = 9, BMRmode = "regular", output_dir = output_dir, output_prefix = "testdiffdriver_reg")
res
```

# Plot specific genes
```{r plot}
load(file.path(outputdir,"testdiffdriver_reg_SmokingCessation_resdd.Rd"))     # load the output file from diffdriver.
g <- "PIK3CA" # only need to change gene name.
rig <- riallg[[g]]
rig$ridx <- 1:dim(rig)[1]
muts <- data.table::fread(mutf, header = T)
if (!grepl('chr', muts$Chromosome[1], fixed = T)) {muts$Chromosome <- paste0("chr",muts$Chromosome)}
muti <- na.omit(ci[rig[muts, on = c("chrom"= "Chromosome", "start" = "Position",  "ref" = "Ref",  "alt"= "Alt")], on = "SampleID"])
mutmtx <- Matrix::sparseMatrix(i = muti$ridx, j = muti$cidx, dims = c(max(rig$ridx), max(ci$cidx)))
bmrmtx= bmrallg[[g]]
ganno <- fannoallg[[g]]

diffdriver::plot_mut(mutmtx=mutmtx, canno=e, bmrmtx=bmrmtx, ganno=ganno)
```


```{r}
sessionInfo()
```
